---
format_version: 9
environments:
  internal:
    pipelines:
      - gocd-trial-launcher
      - gocd-trial-installers
      - gocd-trial-installers-stable
pipelines:
  gocd-trial-launcher:
    group: go-cd-contrib
    display_order: -5
    materials:
      github:
        git: https://git.gocd.io/git/gocd-contrib/gocd-trial-launcher
        destination: launcher
      codesigning:
        git: https://github.com/gocd/codesigning
        destination: codesigning
        ignore:
          - "**/*.*"
          - "**/*"
      signing-keys:
        git: https://git.gocd.io/git/gocd/signing-keys
        destination: signing-keys
        ignore:
          - "**/*.*"
          - "**/*"
    environment_variables:
      RELEASE: 1.0.0
    stages:
      - build:
          elastic_profile_id: ecs-golang-build
          artifacts:
            - build:
                source: dist/**/*
                destination: dist/
          tasks:
          - exec:
              command: /bin/bash
              arguments:
                - build.sh
                - --verbose
                - --prod
              working_directory: launcher
          - exec:
              command: mv
              arguments:
                - dist
                - ..
              working_directory: launcher
      - code-signing:
          clean_workspace: yes
          secure_variables:
            GOCD_GPG_PASSPHRASE: "AES:7lAutKoRKMuSnh3Sbg9DeQ==:8fhND9w/8AWw6dJhmWpTcCdKSsEcOzriQNiKFZD6XtN+sJvZ65NH/QFXRNiy192+SSTKsbhOrFmw+kAKt5+MH1Erd6H54zJjpSgvJUmsJaQ="
          jobs:
            win:
              elastic_profile_id: ecs-gocd-dev-build
              artifacts:
                - build:
                    source: win-launcher.zip
              tasks:
              - fetch:
                  stage: build
                  job: build
                  source: dist/
              - exec:
                  command: rake
                  arguments:
                    - --trace
                    - win:metadata_single_binary[../dist/windows/amd64/run-gocd.exe,../win-launcher.zip]
                  working_directory: codesigning
      - bundle:
          elastic_profile_id: ecs-golang-build
          artifacts:
            - build:
                source: launchers.zip
          tasks:
          - fetch:
              stage: build
              job: build
              source: dist/
          - fetch:
              stage: code-signing
              job: win
              source: win-launcher.zip
              is_file: yes
          - exec:
              command: /bin/bash
              arguments:
                - -c
                - |
                  echo "Collating code-signed binaries..."
                  (cd dist/windows/amd64 && unzip -o ../../../win-launcher.zip)
                  sha256sum dist/darwin/amd64/run-gocd
                  sha256sum dist/darwin/arm64/run-gocd
                  sha256sum dist/linux/amd64/run-gocd
                  sha256sum dist/windows/amd64/run-gocd.exe
          - exec:
              command: zip
              arguments:
                - -r
                - launchers.zip
                - dist
  gocd-trial-installers:
    group: go-cd
    display_order: 5
    materials:
      github:
        git: https://git.gocd.io/git/gocd-contrib/gocd-trial-launcher
      launcher:
        pipeline: gocd-trial-launcher
        stage: bundle
      regression: # Only build new installers every time main regression tests pass
        pipeline: regression-SPAs
        stage: Firefox
    environment_variables:
      GOCD_UPLOAD_S3_BUCKET: downloadgocdio-downloadgocdios3-192sau789jtkh
    stages:
      - package:
          elastic_profile_id: ecs-gocd-dev-build
          artifacts:
            - build:
                source: installers/*
                destination: installers/
          tasks:
          - fetch:
              pipeline: installers
              stage: dist
              job: dist
              source: dist/zip/
              destination: deps/
          - fetch:
              pipeline: gocd-trial-launcher
              stage: bundle
              job: bundle
              source: launchers.zip
              is_file: yes
          - exec:
              command: unzip
              arguments:
                - -o
                - launchers.zip
          - exec:
              command: /bin/bash
              arguments:
                - -c
                - |
                    set -e
                    cd assembly/config
                    gem install bundler
                    bundle
                    bundle exec rake
          - exec:
              command: /bin/bash
              arguments:
                - assembly/package.sh
                - osx
                - osx-aarch64
                - linux
                - windows
      - upload:
          elastic_profile_id: ecs-gocd-dev-build-release-aws-privileged
          tasks:
          - fetch:
              stage: package
              job: package
              source: installers
          - exec:
              command: ruby
              arguments:
                - assembly/upload.rb
                - installers
  gocd-trial-installers-stable:
    group: go-cd
    display_order: 5
    materials:
      github:
        git: https://git.gocd.io/git/gocd-contrib/gocd-trial-launcher
      trial-installers: # Only release installers for each stable release off the same dependent code
        pipeline: gocd-trial-installers
        stage: upload
      publish-stable: # Only release installers for each stable release off the same dependent code
        pipeline: PublishStableRelease
        stage: promote-binaries
    environment_variables:
      GOCD_UPLOAD_S3_BUCKET: downloadgocdio-downloadgocdios3-192sau789jtkh
    stages:
      - promote-to-stable:
          elastic_profile_id: ecs-gocd-dev-build-release-aws-privileged
          tasks:
          - fetch:
              pipeline: gocd-trial-installers
              stage: package
              job: package
              source: installers
          - exec:
              command: ruby
              arguments:
                - assembly/upload.rb
                - --release
                - installers
